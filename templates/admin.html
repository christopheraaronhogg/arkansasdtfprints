{% extends "base.html" %}

{% block content %}
<div class="container">
    <header class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="page-title"><i class="fas fa-clipboard-list me-2"></i>DTF Print Orders</h1>
            <p class="subtitle mb-0">View and manage your print orders</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('export_orders') }}" id="exportBtn" class="action-btn">
                <i class="fas fa-download me-1" style="color: white !important;"></i>Export
            </a>
        </div>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar mb-4">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="search-container flex-grow-1">
                <input type="text" id="searchInput" class="form-control" placeholder="Search orders (order #, PO #, amount...)" oninput="filterOrders()">
            </div>
            <div class="status-toggle">
                <div class="toggle-track">
                    <div class="toggle-slider"></div>
                    <div class="toggle-options">
                        <span class="toggle-option active" data-value="open">Open</span>
                        <span class="toggle-option" data-value="closed">Closed</span>
                        <span class="toggle-option" data-value="">All</span>
                    </div>
                </div>
            </div>
            <input type="date" id="startDate" class="form-control" style="width: auto;" placeholder="Start Date">
            <input type="date" id="endDate" class="form-control" style="width: auto;" placeholder="End Date">
            <button class="action-btn" onclick="clearFilters()">
                <i class="fas fa-times me-1" style="color: white !important;"></i>Clear
            </button>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions mb-3" style="display: none;">
        <div class="d-flex align-items-center gap-2">
            <select id="bulkStatus" class="form-select" style="width: 150px;">
                <option value="">Change Status</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
            </select>
            <button onclick="updateSelectedStatus()" class="action-btn">
                <i class="fas fa-check me-1" style="color: white !important;"></i>Update Selected
            </button>
            <button onclick="showInvoiceModal()" class="action-btn">
                <i class="fas fa-file-invoice me-1" style="color: white !important;"></i>Set Invoice Number
            </button>
            <button onclick="confirmBulkDelete()" class="action-btn btn-danger">
                <i class="fas fa-trash me-1" style="color: white !important;"></i>Delete Selected
            </button>
            <div class="ms-auto">
                <span id="selectedCount" class="text-muted">0 selected</span>
            </div>
        </div>
    </div>

    <div class="order-list">
        {% for order in orders %}
        <div class="order-item" 
             data-status="{{ order.status }}"
             data-date="{{ order.created_at.strftime('%Y-%m-%d') }}">

            <!-- Left Column: Checkbox & Order Info -->
            <div class="info-container">
                <div class="order-select">
                    <input type="checkbox" class="form-check-input order-checkbox" 
                           data-order-id="{{ order.id }}">
                </div>
                <div class="order-details">
                    <h5 class="order-number mb-1">{{ order.order_number }}</h5>
                    <div class="order-meta text-muted">
                        {{ order.created_at|to_central }} <br>
                        {{ order.email }}
                        <br>
                        <button class="invoice-button" onclick="showSingleInvoiceModal({{ order.id }}, '{{ order.invoice_number or '' }}')">
                            <i class="fas fa-file-invoice me-1"></i>
                            {% if order.invoice_number %}
                            Invoice: {{ order.invoice_number }}
                            {% else %}
                            Add Invoice Number
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Images -->
            <div class="order-images">
                {% for item in order.items %}
                <div class="img-container">
                    <div class="img-count-badge">{{ item.quantity }}x</div>
                    <img src="{{ url_for('get_order_thumbnail', order_id=order.id, filename=item.file_key) }}"
                         alt="Preview of {{ item.file_key }}"
                         data-full-image="{{ url_for('get_order_image', order_id=order.id, filename=item.file_key) }}"
                         onclick="showFullSizePreview(this)">
                </div>
                {% endfor %}
            </div>

            <!-- Right Column: Status & Actions -->
            <div class="order-actions">
                <select class="form-select status-select" 
                        data-order-id="{{ order.id }}"
                        value="{{ order.status }}">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
                <div class="order-cost">${{ "%.2f"|format(order.total_cost) }}</div>
                <a href="{{ url_for('view_order', order_id=order.id) }}" class="details-btn">
                    <i class="fas fa-eye me-1" style="color: white !important;"></i>Details
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Image Preview Modal -->
<div id="previewModal" class="modal preview-modal">
    <span class="close-modal" onclick="closePreviewModal()">&times;</span>
    <img id="modalImage" class="modal-image" src="" alt="Full size preview">
    <div class="loading-spinner" style="display: none;">Loading...</div>
</div>

<!-- Add confirmation modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <span class="close-modal" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i><strong>Warning!</strong></p>
            <p>You are about to permanently delete the selected orders and their associated files. This action cannot be undone.</p>
            <p>Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
            <button onclick="executeBulkDelete()" class="action-btn btn-danger">
                <i class="fas fa-trash me-1"></i>Yes, Delete
            </button>
            <button onclick="closeDeleteModal()" class="action-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Invoice Number Modal -->
<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Set Invoice Number</h3>
            <span class="close-modal" onclick="closeInvoiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="invoiceNumber" class="form-label">Invoice Number</label>
                <input type="text" id="invoiceNumber" class="form-control" placeholder="Enter invoice number">
                <div id="invoiceFeedback" class="feedback mt-2"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="executeBulkInvoiceUpdate()" class="action-btn">
                <i class="fas fa-check me-1"></i>Update
            </button>
            <button onclick="closeInvoiceModal()" class="action-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Single Invoice Modal -->
<div id="singleInvoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Invoice Number</h3>
            <span class="close-modal" onclick="closeSingleInvoiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="singleInvoiceNumber" class="form-label">Invoice Number</label>
                <input type="text" id="singleInvoiceNumber" class="form-control" placeholder="Enter invoice number">
                <div id="singleInvoiceFeedback" class="feedback mt-2"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="executeSingleInvoiceUpdate()" class="action-btn">
                <i class="fas fa-check me-1"></i>Update
            </button>
            <button onclick="closeSingleInvoiceModal()" class="action-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Status badge styles - updated */
.status-badge {
    position: relative;
    z-index: 2;
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
}

/* Status-specific colors - only processing remains blue */
.status-badge[data-status="pending"] {
    background-color: var(--warning-color);
    color: white;
}

.status-badge[data-status="processing"] {
    background-color: #3b82f6;
    color: white;
}

.status-badge[data-status="completed"] {
    background-color: var(--success-color);
    color: white;
}

.status-badge:hover {
    opacity: 0.9;
}

/* Consistent button styling */
.action-btn,
.details-btn {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: white !important;
    padding: 0.5rem 1rem !important;
    font-size: 0.9rem !important;
    font-weight: 500 !important;
    line-height: 1.5 !important;
    border-radius: var(--radius-sm) !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
    transition: all 0.2s ease !important;
    height: 38px !important;
    border: none;
    cursor: pointer;
}

.action-btn:hover,
.details-btn:hover {
    background-color: var(--primary-dark) !important;
    border-color: var(--primary-dark) !important;
    color: white !important;
}

/* Force white text color for icons inside buttons */
.action-btn i,
.details-btn i {
    color: white !important;
}

/* Add image count badge */
.img-container {
    position: relative;
}

.img-count-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 2;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
}

@media (max-width: 768px) {
    .img-count-badge {
        font-size: 0.7rem;
        padding: 3px 6px;
    }
}

/* Filter bar and bulk actions styling */
.filter-bar,
.bulk-actions {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.filter-bar:hover,
.bulk-actions:hover {
    box-shadow: var(--shadow-md);
}


/* Status toggle styling */
.status-toggle {
    position: relative;
    width: 300px;
    height: 38px;
}

.toggle-track {
    position: relative;
    width: 100%;
    height: 100%;
    background: #f3f4f6; /* Added subtle grey background */
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.toggle-slider {
    position: absolute;
    width: 33.33%;
    height: calc(100% - 2px);
    background: var(--primary-color);
    border-radius: calc(var(--radius-sm) - 1px);
    top: 1px;
    left: 0;
    transition: transform 0.3s ease;
}

.toggle-options {
    position: relative;
    display: flex;
    height: 100%;
    z-index: 1;
}

.toggle-option {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    transition: color 0.3s ease;
    user-select: none;
}

.toggle-option.active {
    color: white;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
    }

    .filter-bar {
        margin: 1rem;
        padding: 1rem;
        width: auto;
    }

    .filter-bar .d-flex {
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }

    .status-toggle {
        width: 100%;
    }

    .form-control,
    .action-btn {
        width: 100% !important;
    }

    .bulk-actions {
        margin: 1rem;
        padding: 1rem;
    }

    .bulk-actions .d-flex {
        flex-direction: column;
        gap: 1rem;
    }

    .bulk-actions select {
        width: 100% !important;
    }

    #selectedCount {
        text-align: center;
        margin-top: 0.5rem;
    }

    .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        margin: 1rem;
        padding: 1rem;
    }

    .order-details,
    .order-images,
    .order-actions {
        width: 100%;
    }

    .order-images {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        -webkit-overflow-scrolling: touch;
    }

    .order-actions {
        margin-left: 0;
        width: 100%;
        flex-direction: column;
        gap: 0.75rem;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 0.5rem;
        text-align: center;
    }

    .status-badge,
    .details-btn {
        width: auto;
    }

    .img-container {
        flex: 0 0 60px;
        width: 60px;
        height: 60px;
        padding-bottom: 0;
    }
}

/* Rest of your existing styles... */
:root {
    --primary-color: #333333;
    --primary-dark: #1a1a1a;
    --primary-light: #666666;
    --secondary-color: #64748b;
    --background-color: #f1f5f9;
    --surface-color: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border-color: #d1d5db;
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-hover: 0 8px 12px rgba(0, 0, 0, 0.1);
    --radius-sm: 6px;
    --radius-md: 8px;
}

body {
    background-color: var(--background-color);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.order-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.order-details {
    color: var(--text-primary);
    font-size: 1rem;
    margin: 0;
    width: auto !important;
}

.order-meta {
    font-size: 0.85rem;
}


.order-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 200px;
    justify-self: end;  /* This ensures right alignment in grid */
}

.status-select,
.order-cost,
.details-btn {
    width: 100%;
}

.order-cost {
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--success-color);
}

/* Responsive Breakpoints */
@media (max-width: 992px) {
    .order-item {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .order-actions {
        width: 100%;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 0.5rem;
    }

    .status-select,
    .order-cost,
    .details-btn {
        width: 100%;
        max-width: 100%;
    }

    .order-cost {
        text-align: center;  /* Center text on narrow screens */
    }
}

.status-select-wrapper {
    position: relative;
    display: inline-block;
    margin-right: 0;
}

.status-indicator {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    display: none;
}

.status-indicator.show {
    display: block;
}

.badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border-radius: var(--radius-sm);
}

.bg-warning {
    background-color: var(--warning-color) !important;
    color: white;
}

.details-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--primary-color);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.details-btn:hover {
    background: var(--primary-dark);
    color: white;
    text-decoration: none;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--surface-color);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    max-width: 500px;
    width: 100%;
    box-shadow: var(--shadow-md);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text-primary);
}

.modal-body {
    margin-bottom: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.close-modal {
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--text-secondary);
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.form-select,
.form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    line-height: 1.4;
}

.btn-secondary {
    background: var(--secondary-color);
    color: white;
    border: none;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.btn-secondary:hover {
    opacity: 0.9;
}

.date-input.form-control {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    vertical-align: middle;
    padding: 0.5rem 0.75rem;
    line-height: 1.4;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    color: var(--text-primary);
    width: 100%;
    box-sizing: border-box;
    height: 38px;
}

.date-input::-webkit-datetime-edit,
.date-input::-webkit-datetime-edit-fields-wrapper,
.date-input::-webkit-datetime-edit-text,
.date-input::-webkit-datetime-edit-month-field,
.date-input::-webkit-datetime-edit-day-field,
.date-input::-webkit-datetime-edit-year-field {
    margin: 0;
    padding: 0;
}

.date-input::-webkit-calendar-picker-indicator {
    margin: 0;
    padding: 0;
    cursor: pointer;
    margin-top: -2px;
}

.date-input::-ms-clear,
.date-input::-ms-expand {
    display: none;
}

@media (max-width: 768px) {
    .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .order-details,
    .order-images,
    .order-actions {
        width: 100%;
    }

    .order-actions {
        justify-content: flex-start;
    }
}

.date-range-container {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.date-input-wrapper {
    flex: 1;
}

.date-input {
    height: 38px;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    width: 100%;
    font-size: 0.9rem;
    color: var(--text-primary);
    background-color: var(--surface-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.date-input::-webkit-calendar-picker-indicator {
    opacity: 0.7;
    cursor: pointer;
    margin: 0;
    padding-right: 0.5rem;
}

.modal-body .mb-3:last-child {
    margin-bottom: 0;
}


.preview-modal {
    z-index: 1000;
    background: rgba(0, 0, 0, 0.8);
}

.preview-modal img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
}

.close-modal {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    z-index: 1001;
}

/* Dropdown styling */
.status-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-md);
    z-index: 9999; 
    min-width: 120px;
    display: none;
}

.status-dropdown.active {
    display: block;
}

.dropdown-option {
    padding: 0.5rem 1rem;
    cursor: pointer;
    color: var(--text-primary);
}

.dropdown-option:hover {
    background-color: var(--background-color);
}

.dropdown-option:not(:last-child) {
    border-bottom: 1px solid var(--border-color);
}

/* Order item layout */
.order-item {
    display: grid;
    grid-template-columns: 280px 1fr 200px;
    gap: 1.5rem;
    background: var(--surface-color);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    align-items: start;
    width: 100%;
}

/* Middle Column - Images */
.order-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, 70px);
    gap: 0.5rem;
    align-items: start;
    width: 100%;
    justify-content: start;
}

.img-container {
    position: relative;
    width: 100%;
    padding-bottom: 100%;  /* This creates a square aspect ratio */
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.img-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Right Column - Actions */
.order-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 200px;
    justify-self: end;  /* This ensures right alignment in grid */
}

.status-select,
.order-cost,
.details-btn {
    width: 100%;
}

.order-cost {
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--success-color);
}

/* Responsive Breakpoints */
@media (max-width: 992px) {
    .order-item {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .order-actions {
        width: 100%;
        margin-left: 0;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 0.5rem;
        align-items: center;
    }
}

@media (max-width: 768px) {
    .img-container {
        min-width: 60px;
        width: 60px;
        height: 60px;
        padding-bottom: 0;  /* Remove the padding-bottom for mobile */
    }

    .img-container img {
        position: relative;  /* Reset position for mobile */
    }
}

/* Status Select Styling */
.status-select {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border-radius: var(--radius-sm);
    border-color: var(--border-color);
    min-width: 140px;
    font-weight: 500;
    transition: all 0.2s ease;
}

/* Status-specific select styling */
.status-select option {
    background: white;
    color: var(--text-primary);
}

.status-select[value="completed"],
.status-select option[value="completed"],
.status-select:has(option[value="completed"]:checked) {
    background-color: rgba(34, 197, 94, 0.1);
    color: var(--success-color);
    border-color: var(--success-color);
}

.status-select[value="processing"],
.status-select option[value="processing"],
.status-select:has(option[value="processing"]:checked) {
    background-color: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border-color: #3b82f6;
}

.status-select[value="pending"],
.status-select option[value="pending"],
.status-select:has(option[value="pending"]:checked) {
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
    border-color: var(--warning-color);
}

.search-container {
    position: relative;
    flex: 1;
    min-width:250px;}

.search-container .form-control {
    width: 100%;
    padding-right: 2.5rem;
}

@media (max-width: 768px) {
    .filter-bar .d-flex {
        flex-direction: column;
        gap: 1rem;
    }

    .search-container {
        width: 100%;
    }

    .status-toggle,
    .form-control,
    .action-btn {
        width: 100% !important;
    }
}
</style>

<script>
// Show/hide bulk actions based on selection
function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
    const bulkActions = document.querySelector('.bulk-actions');
    document.getElementById('selectedCount').textContent = `${selectedCount} selected`;
    bulkActions.style.display = selectedCount > 0 ? 'block' : 'none';
}

// Update selected orders'status
async function updateSelectedStatus() {
    const selectedStatus = document.getElementById('bulkStatus').value;
    if (!selectedStatus) return;

    const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(checkbox => parseInt(checkbox.dataset.orderId));

    try {
        const response = await fetch('/admin/bulk-status-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_ids: selectedOrders,
                status: selectedStatus
            })
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update orders');
        }
    } catch (error) {
        console.error('Error updating orders:', error);
        alert('Failed to update orders');
    }
}

// Update filtering logic for new status options
function applyFilters(statusOverride) {
    const status = statusOverride !== undefined ? statusOverride : 
        document.querySelector('.toggle-option.active').dataset.value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    const orders = document.querySelectorAll('.order-item');
    orders.forEach(order => {
        let show = true;

        if (status) {
            const orderStatus = order.dataset.status;
            if (status === 'open') {
                show = ['pending', 'processing'].includes(orderStatus);
            } else if (status === 'closed') {
                show = orderStatus === 'completed';
            }
        }

        if (startDate || endDate) {
            const orderDate = order.dataset.date;
            if (startDate && orderDate < startDate) show = false;
            if (endDate && orderDate > endDate) show = false;
        }

        // Use requestAnimationFrame for smoother animations
        requestAnimationFrame(() => {
            if (show) {
                if (order.style.display === 'none') {
                    order.style.display = 'flex';
                    order.style.opacity = '0';
                    order.style.transform = 'translateX(10px)';

                    requestAnimationFrame(() => {
                        order.style.transition = 'opacity 200ms ease, transform 200ms ease';
                        order.style.opacity = '1';
                        order.style.transform = 'translateX(0)';
                    });
                }
            } else {
                if (order.style.display !== 'none') {
                    order.style.transition = 'opacity 200ms ease, transform 200ms ease';
                    order.style.opacity = '0';
                    order.style.transform = 'translateX(-10px)';

                    setTimeout(() => {
                        order.style.display = 'none';
                    }, 200);
                }
            }
        });
    });

    updateExportUrl();
}

function updateExportUrl() {
    const status = document.querySelector('.toggle-option.active').dataset.value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    let url = '/admin/export';
    const params = new URLSearchParams();

    if (status === 'open') {
        params.append('status', 'open');
    } else if (status === 'closed') {
        params.append('status', 'closed');
    }

    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    const exportBtn = document.getElementById('exportBtn');
    exportBtn.href = `${url}?${params.toString()}`;
}

function clearFilters() {
    // Reset the toggle to "Open"
    const toggleOptions = document.querySelectorAll('.toggle-option');
    const slider = document.querySelector('.toggle-slider');

    toggleOptions.forEach(opt => opt.classList.remove('active'));
    toggleOptions[0].classList.add('active');
    slider.style.transform = 'translateX(0)';

    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('searchInput').value = '';
    applyFilters('open');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initStatusToggle();
    applyFilters('open'); // Set initial state to "Open"

    // Add change event listeners for date filters
    ['startDate', 'endDate'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => applyFilters());
    });

    // Add event listeners for checkboxes
    document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Initialize all status selects
    document.querySelectorAll('.status-select').forEach(statusSelect => {
        // Wrap select in a container if not already wrapped
        if (!statusSelect.parentElement.classList.contains('status-select-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'status-select-wrapper';
            statusSelect.parentNode.insertBefore(wrapper, statusSelect);
            wrapper.appendChild(statusSelect);
        }

        // Create status indicator if it doesn't exist
        let statusIndicator = statusSelect.nextElementSibling;
        if (!statusIndicator || !statusIndicator.classList.contains('status-indicator')) {
            statusIndicator = document.createElement('div');
            statusIndicator.className = 'status-indicator';
            statusSelect.parentNode.appendChild(statusIndicator);
        }

        // Set initial value
        statusSelect.setAttribute('value', statusSelect.value);

        // Update value when changed
        statusSelect.addEventListener('change', async function() {
            const newStatus = this.value;
            const orderId = this.dataset.orderId;
            const orderItem = this.closest('.order-item');
            const oldStatus = orderItem.dataset.status;

            // Always show loading state
            this.classList.add('loading');
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            statusIndicator.classList.add('show');

            try {
                const response = await fetch(`/admin/order/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${newStatus}`
                });

                if (response.ok) {
                    // Update the select's value attribute for styling
                    this.setAttribute('value', newStatus);

                    // Show success feedback briefly
                    statusIndicator.innerHTML = '<i class="fas fa-check text-success"></i>';

                    // Update the order item's dataset
                    orderItem.dataset.status = newStatus;

                    // Get current filter state
                    const currentFilter = document.querySelector('.toggle-option.active').dataset.value;

                    // Determine if we need to move the order
                    const wasOpen = ['pending', 'processing'].includes(oldStatus);
                    const isClosed = newStatus === 'completed';

                    // Wait for the success indicator to be shown before moving
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Reset loading state before moving
                    this.classList.remove('loading');
                    statusIndicator.classList.remove('show');

                    if ((wasOpen && isClosed && currentFilter === 'open') || 
                        (!wasOpen && !isClosed && currentFilter === 'closed')) {
                        // Clone the row with updated status
                        const clonedRow = orderItem.cloneNode(true);

                        // Update the cloned row's status select and attributes
                        const clonedSelect = clonedRow.querySelector('.status-select');
                        if (clonedSelect) {
                            clonedSelect.value = newStatus;
                            clonedSelect.setAttribute('value', newStatus);

                            // Update selected state of options
                            clonedSelect.querySelectorAll('option').forEach(option => {
                                option.selected = option.value === newStatus;
                            });
                        }

                        animateAndMove(orderItem, clonedRow, isClosed ? 'closed' : 'open');
                        // Reattach event listeners to cloned row
                        attachEventListeners(clonedRow);
                    }
                } else {
                    throw new Error('Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                // Show error feedback
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';

                // Reset after delay
                setTimeout(() => {
                    this.classList.remove('loading');
                    statusIndicator.classList.remove('show');
                }, 2000);
            }
        });
    });
});

// Existing modal functions remain unchanged
function showFullSizePreview(imgElement) {
    const modal = document.getElementById('previewModal');
    const modalImg = document.getElementById('modalImage');
    const spinner = modal.querySelector('.loading-spinner');

    // Show modal with spinner
    modal.style.display = 'flex';
    spinner.style.display = 'block';
    modalImg.style.display = 'none';

    // Create new image to preload
    const fullImage = new Image();
    fullImage.onload = function() {
        // Hide spinner and show image once loaded
        spinner.style.display = 'none';
        modalImg.src = this.src;
        modalImg.style.display = 'block';
    };
    fullImage.src = imgElement.dataset.fullImage;
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const previewModal = document.getElementById('previewModal');
    if (event.target === previewModal) {
        previewModal.style.display = 'none';
    }
});


function toggleStatusDropdown(badge) {
    // Get the parent order item
    const row = badge.closest('.order-item');

    // Close any open dropdowns first and remove active classes
    document.querySelectorAll('.status-dropdown.active').forEach(dropdown => {
        if (dropdown !== badge.querySelector('.status-dropdown')) {
            dropdown.classList.remove('active');
            dropdown.closest('.order-item').classList.remove('dropdown-active');
        }
    });

    // Toggle current dropdown
    const dropdown = badge.querySelector('.status-dropdown');
    dropdown.classList.toggle('active');

    // Toggle active class on the row
    row.classList.toggle('dropdown-active', dropdown.classList.contains('active'));

    // Add click handlers to options
    dropdown.querySelectorAll('.dropdown-option').forEach(option => {
        option.onclick = async (e) => {
            e.stopPropagation();
            const newStatus = option.dataset.status;
            const orderId = badge.dataset.orderId;

            try {
                const response = await fetch(`/admin/order/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${newStatus}`
                });

                if (response.ok) {
                    // Update badge status and color
                    badge.dataset.status = newStatus;
                    badge.innerHTML = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);

                    // Add the dropdown back after updating text
                    const dropdownHTML = `
                        <div class="status-dropdown">
                            <div class="dropdown-option" data-status="pending">Pending</div>
                            <div class="dropdown-option" data-status="processing">Processing</div>
                            <div class="dropdown-option" data-status="completed">Completed</div>
                        </div>
                    `;
                    badge.innerHTML += dropdownHTML;

                    // Update the order item's dataset
                    row.dataset.status = newStatus;

                    // Remove active classes
                    badge.querySelector('.status-dropdown').classList.remove('active');
                    row.classList.remove('dropdown-active');

                    // Get current filter state
                    const currentFilter = document.querySelector('.toggle-option.active').dataset.value;

                    // Determine visibility in current and other views
                    const isOpenOrder = ['pending', 'processing'].includes(newStatus);
                    const isClosedOrder = newStatus === 'completed';

                    // Clone the row for potential movement to another tab
                    const clonedRow = row.cloneNode(true);

                    // Handle visibility based on current view and new status
                    if (currentFilter === 'open' && !isOpenOrder) {
                        // Moving from open to closed
                        animateAndMove(row, clonedRow, 'closed');
                    } else if (currentFilter === 'closed' && !isClosedOrder) {
                        // Moving from closed to open
                        animateAndMove(row, clonedRow, 'open');
                    }

                    // Reattach event listeners to cloned row if it was moved
                    if (clonedRow.parentNode) {
                        attachEventListeners(clonedRow);
                    }
                } else {
                    console.error('Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        };
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function closeDropdown(e) {
        if (!badge.contains(e.target)) {
            dropdown.classList.remove('active');
            row.classList.remove('dropdown-active');
            document.removeEventListener('click', closeDropdown);
        }
    });
}

// Helper function to animate and move rows between tabs
function animateAndMove(row, clonedRow, targetView) {
    // Shorter animation duration for smoother transitions
    const animationDuration = 200;

    // Fade out from current view
    row.style.transition = `opacity ${animationDuration}ms ease, transform ${animationDuration}ms ease`;
    row.style.opacity = '0';
    row.style.transform = 'translateX(-10px)'; // Reduced movement for snappier feel

    // Handle the transition sooner
    setTimeout(() => {
        // Remove from current view
        row.remove();

        // Add to new view but keep it hidden until that tab is selected
        const orderList = document.querySelector('.order-list');
        if (orderList) {
            // Set initial styles for the cloned row
            clonedRow.style.display = 'none';

            // Position the cloned row at the top of the list
            if (orderList.firstChild) {
                orderList.insertBefore(clonedRow, orderList.firstChild);
            } else {
                orderList.appendChild(clonedRow);
            }

            // Update the display property based on the current view
            const currentFilter = document.querySelector('.toggle-option.active').dataset.value;
            const status = clonedRow.dataset.status;
            const isOpenOrder = ['pending', 'processing'].includes(status);
            const isClosedOrder = status === 'completed';

            let shouldShow = false;
            if (currentFilter === 'open') {
                shouldShow = isOpenOrder;
            } else if (currentFilter === 'closed') {
                shouldShow = isClosedOrder;
            } else {
                shouldShow = true; // 'all' view
            }

            if (shouldShow) {
                clonedRow.style.display = 'flex';
                clonedRow.style.opacity = '0';
                clonedRow.style.transform = 'translateX(10px)'; // Reduced movement


                // Immediate animation for same-tab transitions
                requestAnimationFrame(() => {
                    clonedRow.style.transition = `opacity ${animationDuration}ms ease, transform ${animationDuration}ms ease`;
                    clonedRow.style.opacity = '1';
                    clonedRow.style.transform = 'translateX(0)';
                });
            }
        }
    }, animationDuration);
}

// Helper function to reattach event listeners to cloned elements
function attachEventListeners(clonedRow) {
    // Reattach status badge click handler
    const statusBadge = clonedRow.querySelector('.status-badge');
    if (statusBadge) {
        statusBadge.onclick = () => toggleStatusDropdown(statusBadge);
    }

    // Reattach checkbox change handler
    const checkbox = clonedRow.querySelector('.order-checkbox');
    if (checkbox) {
        checkbox.onchange = () => updateSelectedCount();
    }

    // Reattach image preview handlers
    const images = clonedRow.querySelectorAll('img[onclick]');
    images.forEach(img => {
        img.onclick = () => showFullSizePreview(img);
    });

    // Reattach status select event listener
    const statusSelect = clonedRow.querySelector('.status-select');
    if (statusSelect) {
        // Ensure the select is wrapped properly
        if (!statusSelect.parentElement.classList.contains('status-select-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'status-select-wrapper';
            statusSelect.parentNode.insertBefore(wrapper, statusSelect);
            wrapper.appendChild(statusSelect);
        }

        // Create or get status indicator
        let statusIndicator = statusSelect.nextElementSibling;
        if (!statusIndicator || !statusIndicator.classList.contains('status-indicator')) {
            statusIndicator = document.createElement('div');
            statusIndicator.className = 'status-indicator';
            statusSelect.parentNode.appendChild(statusIndicator);
        }

        // Add change event listener
        statusSelect.addEventListener('change', async function() {
            const newStatus = this.value;
            const orderId = this.dataset.orderId;
            const orderItem = this.closest('.order-item');
            const oldStatus = orderItem.dataset.status;

            // Always show loading state
            this.classList.add('loading');
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            statusIndicator.classList.add('show');

            try {
                const response = await fetch(`/admin/order/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${newStatus}`
                });

                if (response.ok) {
                    // Update the select's value attribute for styling
                    this.setAttribute('value', newStatus);

                    // Show success feedback briefly
                    statusIndicator.innerHTML = '<i class="fas fa-check text-success"></i>';

                    // Update the order item's dataset
                    orderItem.dataset.status = newStatus;

                    // Get current filter state
                    const currentFilter = document.querySelector('.toggle-option.active').dataset.value;

                    // Determine if we need to move the order
                    const wasOpen = ['pending', 'processing'].includes(oldStatus);
                    const isClosed = newStatus === 'completed';

                    // Wait for the success indicator to be shown before moving
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Reset loading state before moving
                    this.classList.remove('loading');
                    statusIndicator.classList.remove('show');

                    if ((wasOpen && isClosed && currentFilter === 'open') || 
                        (!wasOpen && !isClosed && currentFilter === 'closed')) {
                        // Clone the row with updated status
                        const clonedRow = orderItem.cloneNode(true);

                        // Update the cloned row's status select and attributes
                        const clonedSelect = clonedRow.querySelector('.status-select');
                        if (clonedSelect) {
                            clonedSelect.value = newStatus;
                            clonedSelect.setAttribute('value', newStatus);

                            // Update selected state of options
                            clonedSelect.querySelectorAll('option').forEach(option => {
                                option.selected = option.value === newStatus;
                            });
                        }

                        animateAndMove(orderItem, clonedRow, isClosed ? 'closed' : 'open');
                        // Reattach event listeners to cloned row
                        attachEventListeners(clonedRow);
                    }
                } else {
                    throw new Error('Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                // Show error feedback
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';

                // Reset after delay
                setTimeout(() => {
                    this.classList.remove('loading');
                    statusIndicator.classList.remove('show');
                }, 2000);
            }
        });
    }
}

function initStatusToggle() {
    const toggleOptions = document.querySelectorAll('.toggle-option');
    const slider = document.querySelector('.toggle-slider');

    toggleOptions.forEach((option, index) => {
        option.addEventListener('click', () => {
            // Update active state
            toggleOptions.forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');

            // Move slider
            slider.style.transform = `translateX(${index * 100}%)`;

            // Update filters with the new value
            const value = option.dataset.value;
            applyFilters(value);
        });
    });
}

function confirmBulkDelete() {
    const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
    if (selectedCount === 0) {
        alert('Please select at least one order to delete.');
        return;
    }

    document.getElementById('deleteConfirmModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
}

function executeBulkDelete() {
    const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(checkbox => checkbox.dataset.orderId);

    if (selectedOrders.length === 0) {
        closeDeleteModal();
        return;
    }

    fetch('/admin/bulk-delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_ids: selectedOrders
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove deleted orders from the DOM
            selectedOrders.forEach(orderId => {
                const orderElement = document.querySelector(`.order-checkbox[data-order-id="${orderId}"]`)
                    .closest('.order-item');
                if (orderElement) {
                    orderElement.remove();
                }
            });

            // Update bulk actions visibility
            updateSelectedCount();

            // Show success message
            alert(`Successfully deleted ${data.deleted} orders.`);
        } else {
            throw new Error(data.error || 'Failed to delete orders');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete orders: ' + error.message);
    })
    .finally(() => {
        closeDeleteModal();
    });
}

function showInvoiceModal() {
    const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
    if (selectedCount === 0) {
        alert('Please select at least one order to update.');
        return;
    }

    document.getElementById('invoiceModal').style.display = 'flex';
    document.getElementById('invoiceNumber').value = '';
    document.getElementById('invoiceFeedback').textContent = '';
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').style.display = 'none';
}

async function executeBulkInvoiceUpdate() {
    const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(checkbox => parseInt(checkbox.dataset.orderId));

    const invoiceNumber = document.getElementById('invoiceNumber').value;
    const feedback = document.getElementById('invoiceFeedback');

    try {
        const response = await fetch('/admin/bulk-invoice-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_ids: selectedOrders,
                invoice_number: invoiceNumber
            })
        });

        const data = await response.json();

        if (response.ok) {
            closeInvoiceModal();
            alert(`Successfully updated ${data.updated} orders with invoice number: ${invoiceNumber}`);
            location.reload();
        } else {
            feedback.textContent = data.error || 'Failed to update invoice numbers';
            feedback.className = 'feedback text-danger mt-2';
        }
    } catch (error) {
        console.error('Error:', error);
        feedback.textContent = 'Failed to update invoice numbers';
        feedback.className = 'feedback text-danger mt-2';
    }
}

let currentOrderId = null;

function showSingleInvoiceModal(orderId, currentInvoiceNumber) {
    currentOrderId = orderId;
    const modal = document.getElementById('singleInvoiceModal');
    const input = document.getElementById('singleInvoiceNumber');
    const feedback = document.getElementById('singleInvoiceFeedback');

    input.value = currentInvoiceNumber;
    feedback.textContent = '';
    feedback.className = 'feedback mt-2';

    modal.style.display = 'flex';
}

function closeSingleInvoiceModal() {
    const modal = document.getElementById('singleInvoiceModal');
    modal.style.display = 'none';
    currentOrderId = null;
}

async function executeSingleInvoiceUpdate() {
    if (!currentOrderId) return;

    const input = document.getElementById('singleInvoiceNumber');
    const feedback = document.getElementById('singleInvoiceFeedback');
    const invoiceNumber = input.value.trim();

    try {
        const response = await fetch('/update-invoice-number', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: currentOrderId,
                invoice_number: invoiceNumber
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Update the button text in the list
            const orderItem = document.querySelector(`.order-item [onclick*="${currentOrderId}"]`);
            if (orderItem) {
                orderItem.innerHTML = `
                    <i class="fas fa-file-invoice me-1"></i>
                    ${invoiceNumber ? `Invoice: ${invoiceNumber}` : 'Add Invoice Number'}
                `;
            }

            closeSingleInvoiceModal();
            showToast('Invoice number updated successfully', 'success');
        } else {
            feedback.textContent = data.error || 'Failed to update invoice number';
            feedback.className = 'feedback error mt-2';
        }
    } catch (error) {
        console.error('Error:', error);
        feedback.textContent = 'Failed to update invoice number';
        feedback.className = 'feedback error mt-2';
    }
}

// Add toast notification function if not already present
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} toast-icon"></i>
            <span class="toast-message">${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('toast-showing'));

    setTimeout(() => {
        toast.classList.remove('toast-showing');
        toast.classList.add('toast-hiding');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function filterOrders() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const orders = document.querySelectorAll('.order-item');

    orders.forEach(order => {
        // Get all searchable text content from the order
        const orderNumber = order.querySelector('.order-number').textContent.toLowerCase();
        const orderMeta = order.querySelector('.order-meta').textContent.toLowerCase();
        const cost = order.querySelector('.order-cost').textContent.toLowerCase();

        // Get file names from all images
        const fileNames = Array.from(order.querySelectorAll('.img-container img'))
            .map(img => img.getAttribute('alt').toLowerCase());

        // Combine all searchable content
        const searchableContent = [
            orderNumber,
            orderMeta,
            cost,
            ...fileNames
        ].join(' ');

        const matchesSearch = !searchTerm || searchableContent.includes(searchTerm);

        // Get current status and date filters
        const currentStatus = document.querySelector('.toggle-option.active').dataset.value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const orderStatus = order.dataset.status;
        const orderDate = order.dataset.date;

        const matchesStatus = !currentStatus || 
            (currentStatus === 'open' && orderStatus !== 'completed') ||
            (currentStatus === 'closed' && orderStatus === 'completed');

        const matchesDate = (!startDate || orderDate >= startDate) && 
            (!endDate || orderDate <= endDate);

        // Update visibility based on all filters
        order.style.display = (matchesSearch && matchesStatus && matchesDate) ? 'grid' : 'none';
    });
}

// Update the existing event listeners to use the new filter function
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for all filter inputs
    document.getElementById('startDate').addEventListener('change', filterOrders);
    document.getElementById('endDate').addEventListener('change', filterOrders);
    document.getElementById('searchInput').addEventListener('input', filterOrders);
});

// Update existing status toggle handling
document.querySelectorAll('.toggle-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.toggle-option').forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
        filterOrders();
    });
});

</script>
{% endblock %}