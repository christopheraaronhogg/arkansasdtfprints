{% extends "base.html" %}

{% block content %}
<div class="container order-detail-page">
    <!-- Page Header -->
    <header class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="page-title"><i class="fas fa-file-invoice me-2"></i>Order Details</h1>
            <p class="subtitle mb-0">View and manage order information</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin') }}" class="upload-btn">
                <i class="fas fa-arrow-left me-1"></i>Back to Orders
            </a>
            <a href="{{ url_for('download_all_images', order_id=order.id) }}" class="upload-btn">
                <i class="fas fa-download me-1"></i>Download All Files
            </a>
        </div>
    </header>

    {% if order.items|selectattr('notes')|list|length > 0 %}
    <div class="notes-alert">
        <div class="alert-content">
            <i class="fas fa-exclamation-circle"></i>
            <span>This order contains production notes. Please review each item carefully.</span>
        </div>
    </div>
    {% endif %}

    <!-- "Order Information" heading -->
    <h5 class="section-subtitle mb-3">
        <i class="fas fa-info-circle me-2"></i>Order Information
    </h5>

    <!-- Four Info Cards in a row -->
    <div class="info-cards-grid">
        <!-- 1: Order Number -->
        <div class="info-card">
            <div class="card-icon"><i class="fas fa-hashtag"></i></div>
            <div class="info-label">Order Number</div>
            <div class="info-value">{{ order.order_number }}</div>
        </div>

        <!-- 2: Invoice Number -->
        <div class="info-card">
            <div class="card-icon"><i class="fas fa-file-invoice"></i></div>
            <div class="info-label">Invoice Number</div>
            <button class="info-value invoice-button" onclick="showInvoiceModal('{{ order.id }}', '{{ order.invoice_number or '' }}')">
                {% if order.invoice_number %}
                {{ order.invoice_number }}
                {% else %}
                <span class="text-muted">Add Invoice Number</span>
                {% endif %}
            </button>
        </div>

        {% if order.po_number and order.po_number.strip() %}
        <!-- 3: PO Number -->
        <div class="info-card">
            <div class="card-icon"><i class="fas fa-file-alt"></i></div>
            <div class="info-label">PO Number</div>
            <div class="info-value">{{ order.po_number }}</div>
        </div>
        {% endif %}

        <!-- 4: Customer Email -->
        <div class="info-card">
            <div class="card-icon"><i class="fas fa-envelope"></i></div>
            <div class="info-label">Customer Email</div>
            <div class="info-value text-break">{{ order.email }}</div>
        </div>

        <!-- 5: Order Date -->
        <div class="info-card">
            <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
            <div class="info-label">Order Date</div>
            <div class="info-value">
                {{ order.created_at|to_central }}
            </div>
        </div>

        <!-- 5: Total Cost -->
        <div class="info-card">
            <div class="card-icon text-success"><i class="fas fa-dollar-sign"></i></div>
            <div class="info-label">Total Cost</div>
            <div class="info-value text-success">
                ${{ "%.2f"|format(order.total_cost) }}
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-sm-4">
            <strong>Order Date:</strong>
        </div>
        <div class="col-sm-8">
            {{ order.created_at|to_central }}
        </div>
    </div>

    <!-- Order Status section -->
    <h5 class="section-subtitle mt-4 mb-2">
        <i class="fas fa-tasks me-2"></i>Order Status
    </h5>
    <div class="status-card w-100">
        <select name="status" class="form-select status-select w-100" value="{{ order.status }}" data-order-id="{{ order.id }}">
            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
            <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Completed</option>
        </select>
        <div class="status-feedback"></div>
    </div>

    <!-- Order Items -->
    <h4 class="section-heading mt-4 mb-3">Order Items</h4>
    <div class="images-grid">
        {% for item in order.items %}
        <div class="size-inputs">
            <div class="preview-content p-4">
                <div class="preview-section mb-4 position-relative">
                    <div class="quantity-badge">{{ item.quantity }}x</div>
                    <img src="{{ url_for('get_order_image', order_id=order.id, filename=item.file_key) }}"
                         class="preview-image"
                         alt="Preview of {{ item.file_key }}"
                         onclick="showFullSizePreview(this.src)">
                </div>
                <div class="controls-section">
                    <div class="mb-3">
                        <label class="info-label">Dimensions</label>
                        <div class="info-value">{{ item.format_dimensions() }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="info-label">Quantity</label>
                        <div class="info-value">{{ item.quantity }}</div>
                    </div>
                    {% if item.notes %}
                    <div class="mb-3">
                        <label class="info-label">Notes</label>
                        <div class="info-value notes-text">{{ item.notes }}</div>
                    </div>
                    {% endif %}
                    <div>
                        <label class="info-label">Cost</label>
                        <div class="info-value text-success">
                            ${{ "%.2f"|format(item.cost) }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="cost-display">
                <a href="{{ url_for('download_order_image', order_id=order.id, filename=item.file_key) }}" class="details-btn download-btn">
                    <i class="fas fa-download"></i>
                    Download File
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Full Size Preview Modal -->
<div id="previewModal" class="modal">
    <span class="close-modal">&times;</span>
    <img id="modalImage" class="modal-image" src="" alt="Full size preview">
</div>

<!-- Invoice Number Modal -->
<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Invoice Number</h3>
            <span class="close-modal" onclick="closeInvoiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="invoiceNumber" class="form-label">Invoice Number</label>
                <input type="text" id="invoiceNumber" class="form-control" placeholder="Enter invoice number">
                <div id="invoiceFeedback" class="feedback mt-2"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="updateInvoiceNumber()" class="action-btn">
                <i class="fas fa-check me-1"></i>Update
            </button>
            <button onclick="closeInvoiceModal()" class="action-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
/*Existing Styles*/
</style>

<script>
/*Existing Script*/
</script>
{% endblock %}